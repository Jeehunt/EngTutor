{% extends "base.html" %}

{% block content %}

<div class="two-column">
  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤ -->
  <div class="add-col">
    <div class="card add-words-card">
        <div class="card-body">
            <form action="/words/add" method="post" id="addWordsForm">
                <div class="form-group">
                    <label for="words">–°–ª–æ–≤–∞ –∏–ª–∏ —Ñ—Ä–∞–∑—ã:</label>
                    <textarea 
                        id="words" 
                        name="words" 
                        class="form-control" 
                        rows="4" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–∞ –∏–ª–∏ —Ñ—Ä–∞–∑—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏. –ù–∞–ø—Ä–∏–º–µ—Ä:&#10;hello, world&#10;beautiful&#10;to study"
                        required
                    ></textarea>
                <div class="form-info">
                    <button type="submit" class="btn btn-primary" id="addBtn">
                        <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å</span>
                        <span class="btn-loading" style="display: none;">
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            –î–æ–±–∞–≤–ª–µ–Ω–∏–µ...
                        </span>
                    </button>
                    <button type="button" id="clearBtn" class="btn btn-outline-secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                </div>
            </form>
        </div>
    </div>
  </div>

  <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è -->
  <div class="search-col">
    <div class="card search-card">
        <div class="card-body">
            <form method="get" class="search-form">
                <input type="hidden" name="sort" value="{{ sort }}">
                <input type="hidden" name="dir" value="{{ dir }}">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="search">–ü–æ–∏—Å–∫:</label>
                            <input 
                                type="text" 
                                id="search" 
                                name="search" 
                                class="form-control" 
                                placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤—É, –ø–µ—Ä–µ–≤–æ–¥—É, —Ç–µ–≥–∞–º –∏–ª–∏ –≥—Ä—É–ø–ø–µ..."
                                value="{{ search or '' }}"
                            >
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="filter">–§–∏–ª—å—Ç—Ä:</label>
                            <select id="filter" name="filter" class="form-control">
                                <option value="">–í—Å–µ –ø–æ–ª—è</option>
                                <option value="word" {% if filter == 'word' %}selected{% endif %}>–¢–æ–ª—å–∫–æ —Å–ª–æ–≤–∞</option>
                                <option value="translation" {% if filter == 'translation' %}selected{% endif %}>–¢–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥—ã</option>
                                <option value="tags" {% if filter == 'tags' %}selected{% endif %}>–¢–æ–ª—å–∫–æ —Ç–µ–≥–∏</option>
                                <option value="group" {% if filter == 'group' %}selected{% endif %}>–¢–æ–ª—å–∫–æ –≥—Ä—É–ø–ø—ã</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-fill">
                                    <i class="bi bi-search"></i> –ù–∞–π—Ç–∏
                                </button>
                                <a href="/words" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
  </div>
</div>

<!-- –ë–ª–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->

<!-- –¢–∞–±–ª–∏—Ü–∞ —Å–ª–æ–≤ (–∫–æ–º–ø–∞–∫—Ç–Ω–æ, –±–µ–∑ –∫–∞—Ä—Ç–æ—á–∫–∏) -->
<div class="words-toolbar">
    <div class="toolbar-right">
        <span class="word-count">{{ total_words }} —Å–ª–æ–≤</span>
    <form method="get" class="per-page" style="margin:0" onchange="this.submit()">
            <input type="hidden" name="search" value="{{ search or '' }}">
            <input type="hidden" name="filter" value="{{ filter or '' }}">
            <input type="hidden" name="page" value="1">
        <input type="hidden" name="sort" value="{{ sort }}">
        <input type="hidden" name="dir" value="{{ dir }}">
            <select name="per_page" class="form-control" style="min-width: 84px;">
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
            </select>
        </form>
        <span class="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page }} –∏–∑ {{ total_pages }}</span>
    </div>
</div>

{% if words %}
<div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>
                            <a class="sortable" href="?page=1&per_page={{ per_page }}{% if search %}&search={{ search }}{% endif %}{% if filter %}&filter={{ filter }}{% endif %}&sort=id&dir={{ 'asc' if sort == 'id' and dir == 'desc' else 'desc' }}">#</a>
                        </th>
                        <th>
                            <a class="sortable" href="?page=1&per_page={{ per_page }}{% if search %}&search={{ search }}{% endif %}{% if filter %}&filter={{ filter }}{% endif %}&sort=text&dir={{ 'asc' if sort == 'text' and dir == 'desc' else 'desc' }}">–°–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞</a>
                        </th>
                        <th class="col-translations">–ü–µ—Ä–µ–≤–æ–¥—ã</th>
                        <th>–¢–µ–≥–∏</th>
                        <th class="col-group">–ì—Ä—É–ø–ø–∞</th>
                        <th>–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</th>
                        <th>–ü–µ—Ä–µ–≤–æ–¥ –ø—Ä–∏–º–µ—Ä–∞</th>
                        <th>
                            <a class="sortable" href="?page=1&per_page={{ per_page }}{% if search %}&search={{ search }}{% endif %}{% if filter %}&filter={{ filter }}{% endif %}&sort=uses&dir={{ 'asc' if sort == 'uses' and dir == 'desc' else 'desc' }}">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</a>
                        </th>
                        
                    </tr>
                </thead>
                <tbody>
                    {% for word in words %}
                    <tr data-id="{{ word.id }}" data-text="{{ word.text|e }}" data-main="{{ (word.main_translation or '')|e }}" data-group="{{ (word.group_name or '')|e }}">
                        <td class="text-center">{{ word.id }}</td>
                        <td>
                            <a href="#" class="word-link" data-word-id="{{ word.id }}" data-main="{{ (word.main_translation or '')|e }}" data-alts="{{ (word.alt_translations|join(', ') if word.alt_translations else '')|e }}"><strong>{{ word.text }}</strong></a>
                        </td>
                        <td class="col-translations" title="{{ (word.main_translation or '‚Äî') ~ ((' ‚Äî ' ~ (word.alt_translations | join(', '))) if word.alt_translations else '') }}">
                            {% if word.main_translation %}
                                <strong>{{ word.main_translation }}</strong>
                            {% else %}
                                ‚Äî
                            {% endif %}
                            {% if word.alt_translations %}
                                ‚Äî {{ word.alt_translations[:3] | join(', ') }}{% if word.alt_translations|length > 3 %}, +{{ word.alt_translations|length - 3 }}{% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {% if word.tags %}
                                {% for tag in word.tags[:2] %}
                                    <span class="badge bg-info me-1">{{ tag }}</span>
                                {% endfor %}
                                {% if word.tags|length > 2 %}
                                    <span class="badge bg-light text-dark">+{{ word.tags|length - 2 }}</span>
                                {% endif %}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td class="col-group" title="{{ word.group_name or '‚Äî' }}">{{ word.group_name or '‚Äî' }}</td>
                        <td>
                            {% if word.usage_example %}
                                <small>{{ word.usage_example[:50] }}{% if word.usage_example|length > 50 %}...{% endif %}</small>
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td>
                            {% if word.usage_example_translation %}
                                <small>{{ word.usage_example_translation[:50] }}{% if word.usage_example_translation|length > 50 %}...{% endif %}</small>
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-primary">{{ word.uses_count or 0 }}</span>
                        </td>
                        
                    </tr>
                    {% endfor %}
                </tbody>
    </table>
</div>
<!-- Floating action toolbar anchored to viewport right -->
<div id="rowActions" class="row-actions d-none">
    <button class="btn btn-sm btn-outline-primary btn-icon" data-action="copy" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"><i class="bi bi-clipboard"></i></button>
    <button class="btn btn-sm btn-outline-warning btn-icon" data-action="edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><i class="bi bi-pencil"></i></button>
    <button class="btn btn-sm btn-outline-danger btn-icon" data-action="delete" title="–£–¥–∞–ª–∏—Ç—å"><i class="bi bi-trash"></i></button>
    <button class="btn btn-sm btn-outline-primary btn-icon" data-action="examples" title="+5 –ø—Ä–∏–º–µ—Ä–æ–≤">+5</button>
</div>
{% else %}
<div class="empty-state">
    <div class="empty-icon">üìö</div>
    <h4>–°–ª–æ–≤–∞—Ä—å –ø—É—Å—Ç</h4>
    <p>–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ –ø–µ—Ä–≤—ã–µ —Å–ª–æ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–∑—É—á–µ–Ω–∏–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞!</p>
    <p class="text-muted">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º—É –≤—ã—à–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤.</p>
</div>
{% endif %}

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if total_pages > 1 %}
<div class="card pagination-card">
    <div class="card-body">
        <div class="pagination-container">
            <div class="pagination-info">
                <span>–ü–æ–∫–∞–∑–∞–Ω–æ {{ (page - 1) * per_page + 1 }}-{{ min(page * per_page, total_words) }} –∏–∑ {{ total_words }} —Å–ª–æ–≤</span>
            </div>
            <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
                <ul class="pagination">
                    <!-- –ö–Ω–æ–ø–∫–∞ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è" -->
                    {% if has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ prev_page }}&per_page={{ per_page }}{% if search %}&search={{ search }}{% endif %}{% if filter %}&filter={{ filter }}{% endif %}&sort={{ sort }}&dir={{ dir }}">
                            <i class="bi bi-chevron-left"></i> –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">
                            <i class="bi bi-chevron-left"></i> –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                        </span>
                    </li>
                    {% endif %}

                    <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                    {% if start_page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1&per_page={{ per_page }}{% if search %}&search={{ search }}{% endif %}{% if filter %}&filter={{ filter }}{% endif %}&sort={{ sort }}&dir={{ dir }}">1</a>
                    </li>
                    {% if start_page > 2 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endif %}

                    <!-- –°—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ -->
                    {% for p in range(start_page, end_page + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="?page={{ p }}&per_page={{ per_page }}{% if search %}&search={{ search }}{% endif %}{% if filter %}&filter={{ filter }}{% endif %}&sort={{ sort }}&dir={{ dir }}">{{ p }}</a>
                    </li>
                    {% endfor %}

                    <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                    {% if end_page < total_pages %}
                    {% if end_page < total_pages - 1 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ total_pages }}&per_page={{ per_page }}{% if search %}&search={{ search }}{% endif %}{% if filter %}&filter={{ filter }}{% endif %}&sort={{ sort }}&dir={{ dir }}">{{ total_pages }}</a>
                    </li>
                    {% endif %}

                    <!-- –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∞—è" -->
                    {% if has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ next_page }}&per_page={{ per_page }}{% if search %}&search={{ search }}{% endif %}{% if filter %}&filter={{ filter }}{% endif %}&sort={{ sort }}&dir={{ dir }}">
                            –°–ª–µ–¥—É—é—â–∞—è <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">
                            –°–ª–µ–¥—É—é—â–∞—è <i class="bi bi-chevron-right"></i>
                        </span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
</div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning"></i>
                    –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ <strong id="deleteWordText"></strong>?</p>
                <p class="text-muted">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
// –ü–æ–¥—Å—á–µ—Ç —Å–∏–º–≤–æ–ª–æ–≤ –∏ —Å–ª–æ–≤
const textarea = document.getElementById('words');
const clearBtn = document.getElementById('clearBtn');
const addBtn = document.getElementById('addBtn');

function updateCounts() {
    const text = textarea.value;
    const chars = text.length;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (chars > 10000) {
        textarea.style.borderColor = '#dc3545';
        addBtn.disabled = true;
    } else {
        textarea.style.borderColor = '#e1e5e9';
        addBtn.disabled = false;
    }
}

textarea.addEventListener('input', updateCounts);
clearBtn.addEventListener('click', () => {
    textarea.value = '';
    updateCounts();
    textarea.focus();
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
document.getElementById('addWordsForm').addEventListener('submit', function(e) {
    const text = textarea.value.trim();
    if (!text) {
        e.preventDefault();
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É');
        textarea.focus();
        return;
    }
    
    if (text.length > 10000) {
        e.preventDefault();
        alert('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –ú–∞–∫—Å–∏–º—É–º 10,000 —Å–∏–º–≤–æ–ª–æ–≤.');
        textarea.focus();
        return;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
    showLoading();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
    setTimeout(hideLoading, 10000);
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ù–∞—Å—Ç—Ä–æ–π–∫–∏

function copyWord(text, event) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            // –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i>';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-primary');
            }, 1000);
        });
    }
}

function editWord(id, text, translation, group) {
    const newText = prompt('–ò–∑–º–µ–Ω–∏—Ç—å —Å–ª–æ–≤–æ/—Ñ—Ä–∞–∑—É:', text || '');
    if (newText === null) return;
    const newTr = prompt('–ò–∑–º–µ–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥:', translation || '');
    if (newTr === null) return;
    const newGroup = prompt('–ò–∑–º–µ–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É:', group || '');
    if (newGroup === null) return;

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/words/${id}/edit`;
    const f1 = Object.assign(document.createElement('input'), {name: 'text', value: newText});
    const f2 = Object.assign(document.createElement('input'), {name: 'main_translation', value: newTr});
    const f3 = Object.assign(document.createElement('input'), {name: 'group_name', value: newGroup});
    form.appendChild(f1); form.appendChild(f2); form.appendChild(f3);
    document.body.appendChild(form);
    form.submit();
}

function deleteWord(id, text) {
    document.getElementById('deleteWordText').textContent = text;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
    
    document.getElementById('confirmDelete').onclick = function() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/words/${id}/delete`;
        document.body.appendChild(form);
        form.submit();
    };
}

// +5 –ø—Ä–∏–º–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ OpenAI
function showExamples(id, text) {
    fetch(`/words/${id}/examples`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            const list = (data.examples || []).map(it => `<li><strong>${it.en}</strong><br><small>${it.ru}</small></li>`).join('');
            const html = `
            <div class="modal fade" id="examplesModal" tabindex="-1">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">–ü—Ä–∏–º–µ—Ä—ã –¥–ª—è: ${text}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body"><ul style="padding-left:18px; margin:0; display:flex; flex-direction:column; gap:8px;">${list || '<li>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã</li>'}</ul></div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                  </div>
                </div>
              </div>
            </div>`;
            const container = document.createElement('div');
            container.innerHTML = html;
            document.body.appendChild(container);
            const m = new bootstrap.Modal(container.querySelector('#examplesModal'));
            m.show();
            container.addEventListener('hidden.bs.modal', () => container.remove());
        });
}

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
function showLoading() {
    const btnText = addBtn.querySelector('.btn-text');
    const btnLoading = addBtn.querySelector('.btn-loading');
    
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline-flex';
    addBtn.disabled = true;
}

function hideLoading() {
    const btnText = addBtn.querySelector('.btn-text');
    const btnLoading = addBtn.querySelector('.btn-loading');
    
    btnText.style.display = 'inline';
    btnLoading.style.display = 'none';
    addBtn.disabled = false;
}

// –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
textarea.focus();
</script>
<script>
// Popover for word details with instant show, async enrichment, and caching
(function(){
  const table = document.querySelector('.table');
  if (!table) return;
  const cache = new Map(); // wordId -> HTML
  let current = null; // currently open anchor

  function buildInitialHtml(a){
    const text = a.textContent.trim();
    const main = (a.getAttribute('data-main') || '').trim();
    const alts = (a.getAttribute('data-alts') || '').trim();
    const esc = (s) => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const lines = [];
    lines.push(`<div class=\"tooltip-word\"><strong>${esc(text)}</strong></div>`);
    let tr = main ? esc(main) : '‚Äî';
    if (alts) tr += ' ‚Äî ' + esc(alts);
    lines.push(`<div class=\"tooltip-translations\">${tr}</div>`);
    lines.push(`<div class=\"tooltip-synonyms\"><em>Synonyms:</em> <span class=\"text-muted\">–∑–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶</span></div>`);
    lines.push(`<div class=\"tooltip-examples\"><ol style=\"margin:0 0 0 16px; padding:0;\"><li class=\"text-muted\">–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã‚Ä¶</li></ol></div>`);
    return lines.join('');
  }

  function showPopover(a, html){
    // close previous
    if (current && current !== a && current._popover){ current._popover.hide(); current = null; }
    // dispose existing
    if (a._popover){ a._popover.dispose(); a._popover = null; }
    a.setAttribute('data-bs-html', 'true');
    a.setAttribute('data-bs-content', html);
    a.setAttribute('data-bs-toggle', 'popover');
    a.setAttribute('data-bs-placement', 'right');
    // use manual trigger with custom class for styling
    const pop = new bootstrap.Popover(a, {html: true, trigger: 'manual', customClass: 'word-popover', container: 'body'});
    a._popover = pop;
    pop.show();
    current = a;
  }

  function updatePopoverContent(a, html){
    if (!a._popover) return;
    try {
      const tip = a._popover.getTipElement ? a._popover.getTipElement() : null;
      const body = tip ? tip.querySelector('.popover-body') : null;
      if (body) body.innerHTML = html;
      else {
        // fallback: reset content attr and re-show
        a.setAttribute('data-bs-content', html);
        a._popover.dispose();
        const pop = new bootstrap.Popover(a, {html: true, trigger: 'manual', customClass: 'word-popover', container: 'body'});
        a._popover = pop; pop.show();
      }
    } catch(e) {}
  }

  // click outside to close
  document.addEventListener('click', function(ev){
    if (!current) return;
    if (ev.target.closest('.popover') || ev.target.closest('a.word-link') === current) return;
    current._popover && current._popover.hide();
    current = null;
  });

  table.addEventListener('click', async function(e){
    const a = e.target.closest('a.word-link');
    if (!a) return;
    e.preventDefault();
    const id = a.getAttribute('data-word-id');
    // toggle if already open on the same link
    if (current === a){
      a._popover && a._popover.hide();
      current = null;
      return;
    }
    const initial = buildInitialHtml(a);
    showPopover(a, cache.get(id) || initial);
    if (cache.has(id)) return; // already enriched
    try {
      const r = await fetch(`/words/${id}/tooltip`);
      const data = await r.json();
      const html = data && data.html ? data.html : null;
      if (html){
        cache.set(id, html);
        updatePopoverContent(a, html);
      }
    } catch(err) { /* ignore */ }
  });
})();

// Floating actions controller: show on row hover, stick to viewport right
(function(){
  const box = document.getElementById('rowActions');
  if (!box) return;
  let currentRow = null;
  let hideTimer = null;

  function hideSoon(delay=150){
    clearTimeout(hideTimer);
    hideTimer = setTimeout(()=>{ box.classList.add('d-none'); currentRow = null; }, delay);
  }
  function cancelHide(){ clearTimeout(hideTimer); }

  function showForRow(tr){
    cancelHide();
    currentRow = tr;
    // Make visible to measure height correctly
    const wasHidden = box.classList.contains('d-none');
    if (wasHidden) box.classList.remove('d-none');
    const rect = tr.getBoundingClientRect();
    const h = box.offsetHeight || 40;
    let top = Math.round(rect.top + rect.height/2 - h/2);
    // Clamp to viewport (leave header zone ~56px)
    const minTop = 56;
    const maxTop = Math.max(minTop, window.innerHeight - h - 8);
    top = Math.min(Math.max(top, minTop), maxTop);
    box.style.top = top + 'px';
    box.style.right = '12px';
  }

  const tbody = document.querySelector('.table tbody');
  if (!tbody) return;
  tbody.addEventListener('mousemove', (e)=>{
    const tr = e.target.closest('tr');
    if (!tr || !tbody.contains(tr)) return;
    if (tr !== currentRow) showForRow(tr);
  });
  tbody.addEventListener('mouseleave', ()=> hideSoon(200));

  // Keep visible when hovering the panel itself
  box.addEventListener('mouseenter', cancelHide);
  box.addEventListener('mouseleave', ()=> hideSoon(150));

  // Reposition on scroll/resize
  window.addEventListener('scroll', ()=>{ if (currentRow) showForRow(currentRow); }, {passive:true});
  window.addEventListener('resize', ()=>{ if (currentRow) showForRow(currentRow); });

  // Actions
  box.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-action]');
    if (!btn || !currentRow) return;
    const action = btn.getAttribute('data-action');
    const id = currentRow.dataset.id;
    const text = currentRow.dataset.text || '';
    const main = currentRow.dataset.main || '';
    const group = currentRow.dataset.group || '';
    if (action === 'copy') {
      copyWord(text, e);
    } else if (action === 'edit') {
      editWord(id, text, main, group);
    } else if (action === 'delete') {
      deleteWord(id, text);
    } else if (action === 'examples') {
      showExamples(id, text);
    }
  });
})();
</script>
{% endblock %}


